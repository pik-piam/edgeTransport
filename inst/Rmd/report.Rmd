---
title: "Validation EDGE-Transport model"
output:
  pdf_document: default
  df_print: paged
  html_document: null
---

```{r, echo=FALSE, message=FALSE, warning=FALSE}
require(ggplot2)
require(data.table)
require(gridExtra)
require(rmndt)
require(mrremind)

```


```{r, echo=FALSE, warning=FALSE, message=FALSE}
cols <- c("NG" = "#d11141",
          "Liquids" = "#8c8c8c",
          "Hybrid Liquids" = "#ffc425",
          "Hybrid Electric" = "#f37735",
          "BEV" = "#00b159",
          "Electricity" = "#00b159",
          "Electric" = "#00b159",
          "FCEV" = "#00aedb",
          "pchar" = "#00aedb",
          "pinco_tot" = "#00b159",
          "pmod_av" = "#f37735",
          "prange" = "#ffc425",
          "pref" = "#8c8c8c",
          "prisk" = "#d11141",
          "Hydrogen" = "#00aedb",
          "Biodiesel" = "#66a182",
          "Synfuel" = "orchid",
          "Oil" = "#2e4057",
          "fuel price pkm" = "#edae49",
          "Operating costs registration and insurance" = "#8d96a3",
          "Operating costs maintenance" = "#00798c",
          "Capital cost" = "#d1495b",
          "International Aviation" = "#9acd32",
          "AVBUNK" = "#9acd32",
          "Domestic Aviation" = "#7cfc00",
          "DOMESAIR" = "#7cfc00",
          "Bus" = "#32cd32",
          "Passenger Rail" = "#2e8b57",
          "RAIL" = "#2e8b57",
          "Freight Rail" = "#ee4000",
          "Trucks" = "#ff6a6a",
          "ROAD" = "#ff6a6a",
          "ROAD LDV" = "#d11141",
          "ROAD HDV" = "#f37735",
          "International Shipping" = "#cd2626",
          "MARBUNK" = "#cd2626",
          "Domestic Shipping" = "#ff4040",
          "DOMESNAV" = "#ff4040",
          "Shipping" = "#ff4040",
          "Dom. Shipping" = "#ff4040",
          "Non bunkers" = "#9acd32",
          "bunkers" = "#87cefa",
          "Truck" = "#ff7f50",
          "Trucks (<3.5t)" = "#ff7f50",
          "Trucks (3.5t-16)" = "#8b0000",
          "Trucks (>16)" = "#fa8072",
          "Motorbikes" = "#1874cd", #"dodgerblue3",
          "Small Cars" = "#87cefa",
          "Large Cars" = "#6495ed",
          "Van" = "#40e0d0",
          "LDV" = "#00bfff",
          "Non motorized" = "#da70d6",
          "Freight"="#ff0000",
          "Freight (Inland)" = "#cd5555",
          "Pass non LDV" = "#6b8e23",
          "Pass" = "#66cdaa",
          "Pass non LDV (Domestic)" = "#54ff9f",
          "refined liquids enduse" = "#8c8c8c")

datapath <- function(fname){
  file.path("./", fname)
}

datapath_level0 <- function(fname){
  file.path("../level_0", fname)
}

## load input data from last EDGE run
demand_km <- readRDS(datapath(fname = "demandF_plot_pkm.RDS")) ## detailed energy services demand, million km
demand_ej <- readRDS(datapath(fname = "demandF_plot_EJ.RDS")) ## detailed final energy demand, EJ
vintcomp <- readRDS(datapath(fname = "vintcomp.RDS"))
newcomp <- readRDS(datapath(fname = "newcomp.RDS"))
shares <- readRDS(datapath(fname = "shares.RDS"))
pref <- readRDS(datapath(fname = "pref_output.RDS"))
mj_km_data <- readRDS(datapath(fname = "mj_km_data.RDS"))
loadFactor <- readRDS(datapath(fname = "loadFactor.RDS"))
annual_mileage <- readRDS(datapath(fname = "annual_mileage.RDS"))
annual_sale <- readRDS(datapath(fname = "annual_sales.RDS"))
bunk_EU <- readRDS(datapath(fname = "EurostatBunkers.RDS"))
demEJ_TRACCS <- readRDS(datapath(fname = "TRACCS_FE.RDS"))
techcost <- readRDS(datapath_level0(fname = "REMINDdat.RDS"))[["NFcost"]]
## Load population to calculate per capita values
POP = readRDS(datapath(fname = "POP.RDS"))
## load IEA data as a comparison
IEA = readRDS(datapath(fname = "IEAcomp.RDS"))

maxyear = 2060

EU_regions = c("DEU", "ECE", "ECS", "ENC", "ESC", "ESW", "EWN", "FRA", "UKI")
NEU_regions = c("NES", "NEN")
non_EU_regions = c("OAS", "MEA", "SSA" ,"LAM" ,"REF" ,"CAZ" ,"CHA", "IND" ,"JPN","USA")

theme_plot = theme_minimal()+
    theme(axis.text.x = element_text(angle = 90,  size = 8, vjust=0.5, hjust=1),
          axis.text.y = element_text(size = 8),
          axis.title = element_text(size = 8),
          title = element_text(size = 8),
          legend.text = element_text(size = 8),
          legend.title = element_text(size = 8),
          strip.text = element_text(size = 8),
          strip.background = element_rect(color = "grey"),
          axis.line = element_line(size = 0.5, colour = "grey"))


JRC_IDEES_Trsp = readSource("JRC_IDEES", subtype="Transport")
JRC_IDEES_MarBunk = readSource("JRC_IDEES", subtype="Mbunkers")
REMIND2ISO_MAPPING = fread(system.file("extdata", "regionmapping_21_EU11.csv", package = "edgeTransport"))[, .(iso = CountryCode,region = RegionCode)]

## filter only non-NA countries from IDEES and transform in data table
JRC_IDEES=rbind(
  as.data.table(JRC_IDEES_Trsp), as.data.table(JRC_IDEES_MarBunk))
JRC_IDEES=JRC_IDEES[grep("nergy consumption",variable.unit)]
JRC_IDEES=JRC_IDEES[!grep("Shares",variable.unit)]
JRC_IDEES=merge(JRC_IDEES,REMIND2ISO_MAPPING,by.x="iso3c",by.y="iso")
JRC_IDEES=JRC_IDEES[,.(value=sum(value)),by = c("variable.unit","region","year")]
JRC_IDEES[,year :=as.numeric(gsub("y","",year))]
JRC_IDEES=JRC_IDEES[year %in%c(1990,2000,2005,2010,2015)]
JRC_IDEES[, EJ:= value*  ##in ktoe
              1e3*    ## in toe
              4.1868E-8]  ## in EJ
useful_var = c(
  ## international shipping
  "Maritime bunkers|Energy Consumption|Total energy consumption.ktoe",
  ## international aviation
  "Transport|Aviation|Energy Consumption|Total energy consumption|Passenger transport|International - Extra-EU.ktoe",
  "Transport|Aviation|Energy Consumption|Total energy consumption|Passenger transport|International - Intra-EU.ktoe",
  ## domestic shipping
  "Transport|Navigation|Energy Consumption|Total energy consumption.ktoe",
  ## domestic aviation
  "Transport|Aviation|Energy Consumption|Total energy consumption|Passenger transport|Domestic.ktoe",
  ## road freight
  "Transport|Energy consumption|Freight transport|Road transport|Heavy duty vehicles.ktoe",
  ## road passenger LDVs
  "Transport|Energy consumption|Passenger transport|Road transport|Passenger cars.ktoe",
  ## road passenger HDVs
  "Transport|Road|Energy Consumption|Total energy consumption|Passenger transport|Motor coaches, buses and trolley buses.ktoe",
  ## rail passenger
  "Transport|Rail|Energy Consumption|Total energy consumption|Passenger transport|Conventional passenger trains.ktoe",
  ## rail freight
  "Transport|Rail|Energy Consumption|Total energy consumption|Freight transport.ktoe"
)

JRC_IDEES = JRC_IDEES[variable.unit %in% useful_var]


mapping_JRC_IDEE = data.table(variable.unit = c(
    ## international shipping
    "Maritime bunkers|Energy Consumption|Total energy consumption.ktoe",
    ## international aviation
    "Transport|Aviation|Energy Consumption|Total energy consumption|Passenger transport|International - Extra-EU.ktoe",
    "Transport|Aviation|Energy Consumption|Total energy consumption|Passenger transport|International - Intra-EU.ktoe",
    ## domestic shipping
    "Transport|Navigation|Energy Consumption|Total energy consumption.ktoe",
    ## domestic aviation
    "Transport|Aviation|Energy Consumption|Total energy consumption|Passenger transport|Domestic.ktoe",
    ## road freight
    "Transport|Energy consumption|Freight transport|Road transport|Heavy duty vehicles.ktoe",
    ## road passenger LDVs
    "Transport|Energy consumption|Passenger transport|Road transport|Passenger cars.ktoe",
    ## road passenger HDVs
    "Transport|Road|Energy Consumption|Total energy consumption|Passenger transport|Motor coaches, buses and trolley buses.ktoe",
    ## rail passenger
    "Transport|Rail|Energy Consumption|Total energy consumption|Passenger transport|Conventional passenger trains.ktoe",
    ## rail freight
    "Transport|Rail|Energy Consumption|Total energy consumption|Freight transport.ktoe"
  ),
  flow = c(
    ## international shipping
    "MARBUNK",
    ## international aviation
    "AVBUNK",
    "AVBUNK",
    ## domestic shipping
    "DOMESNAV",
    ## domestic aviation
    "DOMESAIR",
    ## road freight
    "ROAD HDV",
    ## road passenger LDVs
    "ROAD LDV",
    ## road passenger HDVs
    "ROAD HDV",
    ## rail passenger
    "RAIL",
    ## rail freight
    "RAIL"
  )
  )

JRC_IDEES= merge(JRC_IDEES, mapping_JRC_IDEE, by ="variable.unit")

JRC_IDEES=JRC_IDEES[,.(value = sum(EJ)), by = .(region, year, flow)]
```




# Inconvenience cost trend

```{r, echo=FALSE, warning=FALSE, message=FALSE}

plotinconv = function(inco_tech, vt, reggroup){
  cols2use=as.character(unique(inco_tech[subsector_L1 == "trn_pass_road_LDV_4W",logit_type]))
  p=ggplot()+
    geom_bar(data = inco_tech[subsector_L1 == "trn_pass_road_LDV_4W" & vehicle_type == vt & year<=maxyear & year>=2010 & region %in% reggroup], aes(x = as.character(year), y = value, group = logit_type, fill = logit_type), position = position_stack(), stat = "identity")+
    facet_grid(region~technology, scales = "free")+
    theme_minimal()+
    expand_limits(y = c(0,0.8))+
    scale_x_discrete(breaks = c(2015,2050,maxyear))+
    theme(axis.text.x = element_text(angle = 90, vjust = +0.1),
          strip.background = element_rect(color = "grey"))+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    labs(x = "", y = "Inconvenience cost [$/pkm]", title = paste0("Example of ", vt))

  return(p)
}
plots = list()
for (reggroup in list(EU_regions = EU_regions, NEU_regions = NEU_regions, non_EU_regions = non_EU_regions)) {
p1 = plotinconv(inco_tech = pref$FV_final_pref, vt = "Large Car and SUV", reggroup = reggroup)

plots=list(plots,p1)
}

plots

```


# Final energy demand

```{r, echo=FALSE, warning=FALSE, message=FALSE}
demandEJplotf = function(demandEJ, POP){
  ## EDGE results
  demandEJ <- demandEJ[, c("sector", "subsector_L3", "subsector_L2", "subsector_L1", "vehicle_type", "technology", "region", "year", "demand_EJ")]

  ## attribute aggregated mode and vehicle names for plotting purposes, and aggregate
  demandEJ[, aggr_mode := ifelse(subsector_L2 == "trn_pass_road_LDV", "LDV", NA)]
  demandEJ[, aggr_mode := ifelse(subsector_L3 %in% c("Passenger Rail", "HSR", "International Aviation", "Domestic Aviation"), "Pass non LDV", aggr_mode)]
  demandEJ[, aggr_mode := ifelse(subsector_L2 %in% c("trn_pass_road_bus", "Bus"), "Pass non LDV", aggr_mode)]
  demandEJ[, aggr_mode := ifelse(is.na(aggr_mode), "Freight", aggr_mode)]
  demandEJ[, veh := ifelse(grepl("Large|SUV|Midsize|Multipurpose Vehicle|Van|3W Rural", vehicle_type), "Large Cars", NA)]
  demandEJ[, veh := ifelse(grepl("Subcompact|Compact|Mini", vehicle_type), "Small Cars", veh)]
  demandEJ[, veh := ifelse(grepl("Motorcycle|Moped|Scooter", vehicle_type), "Motorbikes", veh)]
  demandEJ[, veh := ifelse(grepl("bus|Bus", vehicle_type), "Bus", veh)]
  demandEJ[, veh := ifelse(grepl("Truck", vehicle_type) & vehicle_type != "Light Truck and SUV", "Truck", veh)]
  demandEJ[, veh := ifelse(grepl("Freight Rail_tmp_vehicletype", vehicle_type), "Freight Rail", veh)]
  demandEJ[, veh := ifelse(grepl("Passenger Rail|HSR", vehicle_type), "Passenger Rail", veh)]
  demandEJ[, veh := ifelse(subsector_L3 == "Domestic Ship", "Domestic Shipping", veh)]
  demandEJ[, veh := ifelse(subsector_L3 == "International Ship", "International Shipping", veh)]
  demandEJ[, veh := ifelse(subsector_L3 == "Domestic Aviation", subsector_L3, veh)]
  demandEJ[, veh := ifelse(subsector_L3 == "International Aviation", subsector_L3, veh)]
  demandEJ[, veh := ifelse(is.na(veh), vehicle_type, veh)]
  demandEJ = demandEJ[,.(demand_EJ, region, year, aggr_mode, veh)]

  demandEJ[, vehicle_type_plot := factor(veh, levels = c("LDV","Freight Rail", "Truck","Domestic Shipping", "International Shipping",
                                                         "Motorbikes", "Small Cars", "Large Cars", "Van",
                                                         "Domestic Aviation", "International Aviation", "Bus", "Passenger Rail",
                                                         "Freight", "Freight (Inland)", "Pass non LDV", "Pass non LDV (Domestic)"))]

  legend_ord <- c("Freight Rail", "Truck", "International Shipping","Domestic Shipping",
                  "Motorbikes", "Small Cars", "Large Cars", "Van",
                  "International Aviation", "Domestic Aviation","Bus", "Passenger Rail",
                  "Freight", "LDV", "Pass non LDV", "Freight (Inland)", "Pass non LDV (Domestic)")
  demandEJ = demandEJ[,.(demand_EJ = sum(demand_EJ)), by = .(region, year, vehicle_type_plot, aggr_mode)]

  demandEJglob = demandEJ[,.(demand_EJ = sum(demand_EJ)), by = .(year, vehicle_type_plot, aggr_mode)][, region:= "World"]

  demandEJEU = demandEJ[region %in% EU_regions,.(demand_EJ = sum(demand_EJ)), by = .(year, vehicle_type_plot, aggr_mode)][, region:= "EUR"]

  demandEJNEU = demandEJ[region %in% non_EU_regions,.(demand_EJ = sum(demand_EJ)), by = .(year, vehicle_type_plot, aggr_mode)][, region:= "NEU"]

  demandEJ = rbind(demandEJglob,demandEJ,demandEJEU,demandEJNEU)
  ## calculate per capita demand
  demandEJcap = merge(demandEJ , POP, all.x = TRUE, by =c("year", "region"))
  demandEJcapglob = demandEJcap[,.(demand_EJ = sum(demand_EJ), value = sum(value)), by = .(year, vehicle_type_plot, aggr_mode)][, region:= "World"]

  demandEJcap = rbind(demandEJcap, demandEJcapglob)

  ## calculate per capita values
  demandEJcap = demandEJcap[order(aggr_mode)]
  demandEJcap[, cap_dem := demand_EJ*    ## in EJ
                1e+09/        ## in GJ
                value*          ## in million km
                1e-6]          ## in people/millionpeople=GJ/person

  cols2use=as.character(unique(demandEJ[aggr_mode %in% c("LDV", "Pass non LDV"),vehicle_type_plot]))
  ppass=ggplot()+
    geom_area(data = demandEJ[year > 2005 & year <= maxyear  & aggr_mode %in% c("LDV", "Pass non LDV") & region %in% EU_regions], aes(x=year, y=demand_EJ, group = interaction(vehicle_type_plot,aggr_mode), fill = vehicle_type_plot), color = "black", position= position_stack())+
    facet_wrap(~region, nrow = 4, scales = "free")+
    labs(x = "", y = "Passenger final Energy demand [EJ]")+
    theme_minimal()+
     scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme(axis.text.x = element_text(angle = 90,  size = 7, vjust=0.5, hjust=1),
          axis.text.y = element_text(size=8),
          axis.title = element_text(size = 9),
          title = element_text(size = 9),
          legend.text = element_text(size = 9),
          legend.title = element_text(size =9),
          strip.text = element_text(size=9))

  ppass1=ggplot()+
    geom_area(data = demandEJ[year > 2005 & year <= maxyear  & aggr_mode %in% c("LDV", "Pass non LDV") & !region %in% EU_regions], aes(x=year, y=demand_EJ, group = interaction(vehicle_type_plot,aggr_mode), fill = vehicle_type_plot), color = "black", position= position_stack())+
    facet_wrap(~region, nrow = 4, scales = "free")+
    labs(x = "", y = "Passenger final Energy demand [EJ]")+
    theme_minimal()+
     scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme(axis.text.x = element_text(angle = 90,  size = 7, vjust=0.5, hjust=1),
          axis.text.y = element_text(size=8),
          axis.title = element_text(size = 9),
          title = element_text(size = 9),
          legend.text = element_text(size = 9),
          legend.title = element_text(size =9),
          strip.text = element_text(size=9))

  cols2use=as.character(unique(demandEJ[aggr_mode %in% c("Freight"),vehicle_type_plot]))
  pfreight=ggplot()+
    geom_area(data = demandEJ[year > 2005 & year <= maxyear  & aggr_mode %in% c("Freight")&region%in% EU_regions], aes(x=year, y=demand_EJ, group = interaction(vehicle_type_plot,aggr_mode), fill = vehicle_type_plot), color = "black", position= position_stack())+
    facet_wrap(~region, nrow = 4, scales = "free")+
    labs(x = "", y = "Freight final Energy demand [EJ]")+
    theme_minimal()+
     scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme(axis.text.x = element_text(angle = 90,  size = 7, vjust=0.5, hjust=1),
          axis.text.y = element_text(size=8),
          axis.title = element_text(size = 9),
          title = element_text(size = 9),
          legend.text = element_text(size = 9),
          legend.title = element_text(size =9),
          strip.text = element_text(size=9))

    pfreight1=ggplot()+
    geom_area(data = demandEJ[year > 2005 & year <= maxyear  & aggr_mode %in% c("Freight") & !region%in%EU_regions], aes(x=year, y=demand_EJ, group = interaction(vehicle_type_plot,aggr_mode), fill = vehicle_type_plot), color = "black", position= position_stack())+
    facet_wrap(~region, nrow = 4, scales = "free")+
    labs(x = "", y = "Freight final Energy demand [EJ]")+
    theme_minimal()+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme(axis.text.x = element_text(angle = 90,  size = 7, vjust=0.5, hjust=1),
          axis.text.y = element_text(size=8),
          axis.title = element_text(size = 9),
          title = element_text(size = 9),
          legend.text = element_text(size = 9),
          legend.title = element_text(size =9),
          strip.text = element_text(size=9))


  cols2use=as.character(unique(demandEJcap[, vehicle_type_plot]))
  pcap1=ggplot()+
    geom_area(data = demandEJcap[year > 2005 & year <= maxyear  & region %in% c(EU_regions, NEU_regions)], aes(x=year, y=cap_dem, group = interaction(vehicle_type_plot,aggr_mode), fill = vehicle_type_plot), color = "black", position= position_stack())+
    facet_wrap(~region, nrow = 4, scales = "free")+
    labs(x = "", y = "Final Energy demand [GJ/cap]")+
    theme_minimal()+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme(axis.text.x = element_text(angle = 90,  size = 7, vjust=0.5, hjust=1),
          axis.text.y = element_text(size=8),
          axis.title = element_text(size = 9),
          title = element_text(size = 9),
          legend.text = element_text(size = 9),
          legend.title = element_text(size =9),
          strip.text = element_text(size=9))

    pcap2=ggplot()+
    geom_area(data = demandEJcap[year > 2005 & year <= maxyear  & region %in% non_EU_regions], aes(x=year, y=cap_dem, group = interaction(vehicle_type_plot,aggr_mode), fill = vehicle_type_plot), color = "black", position= position_stack())+
    facet_wrap(~region, nrow = 4, scales = "free")+
    labs(x = "", y = "Final Energy demand [GJ/cap]")+
    theme_minimal()+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme(axis.text.x = element_text(angle = 90,  size = 7, vjust=0.5, hjust=1),
          axis.text.y = element_text(size=8),
          axis.title = element_text(size = 9),
          title = element_text(size = 9),
          legend.text = element_text(size = 9),
          legend.title = element_text(size =9),
          strip.text = element_text(size=9))



  return(list(ppass = ppass, ppass1=ppass1, pfreight = pfreight, pfreight1 = pfreight1,pcap1 = pcap1, pcap2 = pcap2))
}

## Final Energy demand
demEJ = demandEJplotf(demand_ej, POP)
demEJ
```


# Ratio of FE and ES

```{r, echo=FALSE, warning=FALSE, message=FALSE}
ratioENplotf = function(demandEJ, demandkm){
  ## EDGE results
  demandEJ <- demandEJ[, c("sector", "subsector_L3", "subsector_L2", "subsector_L1", "vehicle_type", "technology", "region", "year", "demand_EJ")]

  ## attribute aggregated mode and vehicle names for plotting purposes, and aggregate
  demandEJ[, veh := ifelse(grepl("Large|SUV|Midsize|Multipurpose Vehicle|Van|3W Rural|Subcompact|Compact|Mini", vehicle_type), "LDV", NA)]
  demandEJ[, veh := ifelse(grepl("Motorcycle|Moped|Scooter", vehicle_type), "LDV", veh)]
  demandEJ[, veh := ifelse(grepl("bus|Bus", vehicle_type), "Bus", veh)]
  demandEJ[, veh := ifelse(grepl("Truck", vehicle_type) & vehicle_type != "Light Truck and SUV", "Truck", veh)]
  demandEJ[, veh := ifelse(grepl("Freight Rail_tmp_vehicletype", vehicle_type), "Freight Rail", veh)]
  demandEJ[, veh := ifelse(grepl("Passenger Rail|HSR", vehicle_type), "Passenger Rail", veh)]
  demandEJ[, veh := ifelse(subsector_L3 == "Domestic Ship", "Domestic Shipping", veh)]
  demandEJ[, veh := ifelse(subsector_L3 == "International Ship", "International Shipping", veh)]
  demandEJ[, veh := ifelse(subsector_L3 == "Domestic Aviation", subsector_L3, veh)]
  demandEJ[, veh := ifelse(subsector_L3 == "International Aviation", subsector_L3, veh)]
  demandEJ[, veh := ifelse(is.na(veh), vehicle_type, veh)]
  demandEJ = demandEJ[,.(demand_EJ, region, year, veh)]
  demandEJ= demandEJ[,.(demand_EJ = sum(demand_EJ)), by = c("region", "year", "veh")]

  demandEJ[, vehicle_type_plot := factor(veh, levels = c("LDV","Freight Rail", "Truck","Domestic Shipping", "International Shipping",
                                                         "Motorbikes", "Small Cars", "Large Cars", "Van",
                                                         "Domestic Aviation", "International Aviation", "Bus", "Passenger Rail",
                                                         "Freight", "Freight (Inland)", "Pass non LDV", "Pass non LDV (Domestic)"))]


  demandkm<- demandkm[,c("sector","subsector_L3","subsector_L2",
                         "subsector_L1","vehicle_type","technology", "region","year","demand_F")]
  demandkm[,demand_F:=demand_F   ## in millionkm
           *1e-6                      ## in trillion km
           ]
  ## attribute aggregated mode and vehicle names for plotting purposes, and aggregate
  demandkm[, veh := ifelse(grepl("Truck", vehicle_type) & vehicle_type != "Light Truck and SUV" | vehicle_type == "3W Rural", "Truck", NA)]
  demandkm[, veh := ifelse(grepl("Large|SUV|Midsize|Multipurpose Vehicle|Van|Light Truck and SUV|Subcompact|Compact|Mini", vehicle_type), "LDV", veh)]
  demandkm[, veh := ifelse(grepl("Motorcycle|Moped|Scooter", vehicle_type), "LDV", veh)]
  demandkm[, veh := ifelse(grepl("bus|Bus", vehicle_type), "Bus", veh)]
  demandkm[, veh := ifelse(subsector_L3 == "Domestic Aviation", "Domestic Aviation", veh)]
  demandkm[, veh := ifelse(subsector_L3 == "International Aviation", "International Aviation", veh)]
  demandkm[, veh := ifelse(subsector_L3 == "Domestic Ship", "Domestic Shipping", veh)]
  demandkm[, veh := ifelse(subsector_L3 == "International Ship", "International Shipping", veh)]
  demandkm[, veh := ifelse(grepl("Freight Rail", vehicle_type), "Freight Rail", veh)]
  demandkm[, veh := ifelse(grepl("Passenger Rail|HSR", vehicle_type), "Passenger Rail", veh)]
  demandkm[, veh := ifelse(grepl("Ship", vehicle_type), "Shipping", veh)]
  demandkm[, veh := ifelse(grepl("Cycle|Walk", subsector_L3), "Non motorized", veh)]
  demandkm = demandkm[,.(demand_F = sum(demand_F)), by = c("region", "year","veh")]
  setnames(demandkm, old = "veh", new = "vehicle_type")
  demandkm= demandkm[,.(demand_F = sum(demand_F)), by = c("region", "year", "vehicle_type")]

  demandkm[, vehicle_type_plot := factor(vehicle_type, levels = c("LDV","Truck",
                                                                  "Freight Rail",
                                                                  "Motorbikes", "Small Cars", "Large Cars", "Van",
                                                                  "Domestic Aviation", "International Aviation","Bus", "Passenger Rail",
                                                                  "Freight", "Non motorized", "Shipping"))]


  demandkm[, mode := ifelse(vehicle_type %in% c("Freight", "Freight Rail", "Truck", "Shipping"),"freight", "pass")]

  demandkm= demandkm[, .(demand_F = sum(demand_F)), by = c("region", "year", "vehicle_type_plot")]


  legend_ord <- c("Freight Rail", "Truck", "International Shipping","Domestic Shipping",
                  "Motorbikes", "Small Cars", "Large Cars", "Van",
                  "International Aviation", "Domestic Aviation","Bus", "Passenger Rail",
                  "Freight", "LDV", "Pass non LDV", "Freight (Inland)", "Pass non LDV (Domestic)")

  ## calculate the ratio
  demandEN = merge(demandEJ , demandkm, all.x = TRUE, by =c("year", "region","vehicle_type_plot"))
  demandEN[, ENint := demand_EJ*        ## in EJ
                      277777777777.78  ## in kWh
                      /(demand_F*      ## in trillionkm
                        1e12)]          ## in pkm or tkm
demandEN = demandEN[vehicle_type_plot %in% c("LDV", "Bus", "Passenger Rail")]
  cols2use = as.character(unique(demandEN[,vehicle_type_plot]))

  ppass=ggplot()+
    geom_line(data = demandEN[year > 2005 & year <= maxyear &  region %in% EU_regions], aes(x=year, y=ENint, group = vehicle_type_plot, color = vehicle_type_plot))+
    facet_wrap(~region, nrow = 4, scales = "free")+
    labs(x = "", y = "Passenger energy intensity [kwh/pkm]")+
    theme_minimal()+
     scale_color_manual(values = cols[match(cols2use, names(cols))])+
    theme(axis.text.x = element_text(angle = 90,  size = 7, vjust=0.5, hjust=1),
          axis.text.y = element_text(size=8),
          axis.title = element_text(size = 9),
          title = element_text(size = 9),
          legend.text = element_text(size = 9),
          legend.title = element_text(size =9),
          strip.text = element_text(size=9))

  ppass1=ggplot()+
    geom_line(data = demandEN[year > 2005 & year <= maxyear & !region %in% EU_regions], aes(x=year, y=ENint, group = vehicle_type_plot, color = vehicle_type_plot))+
    facet_wrap(~region, nrow = 4, scales = "free")+
    labs(x = "", y = "Passenger energy intensity [kwh/pkm]")+
    theme_minimal()+
     scale_color_manual(values = cols[match(cols2use, names(cols))])+
    theme(axis.text.x = element_text(angle = 90,  size = 7, vjust=0.5, hjust=1),
          axis.text.y = element_text(size=8),
          axis.title = element_text(size = 9),
          title = element_text(size = 9),
          legend.text = element_text(size = 9),
          legend.title = element_text(size =9),
          strip.text = element_text(size=9))

  return(list(ppass = ppass, ppass1 = ppass1))
}

ratioENplotf(demand_ej, demand_km)

```

# Total FE demand bunkers and no bunkers

```{r, echo=FALSE, warning=FALSE, message=FALSE}
demandBunkNoBunkplotf = function(demandEJ, POP){
  ## EDGE results
  demandBnB <- demandEJ[, c("sector", "subsector_L3", "subsector_L2", "subsector_L1", "vehicle_type", "technology", "region", "year", "demand_EJ")]

  demandBnB[, aggr_mode := ifelse(subsector_L3 %in% c("International Aviation", "International Shipping"), "bunkers", "Non bunkers")]
  demandBnB = demandBnB[,.(demand_EJ, region, year, aggr_mode)]

  demandBnB[, aggr_mode := factor(aggr_mode, levels = c("Non bunkers", "bunkers"))]

  legend_ord <- c("Non bunkers", "bunkers")
  demandBnB = demandBnB[,.(demand_EJ = sum(demand_EJ)), by = .(region, year, aggr_mode)]

  demandBnBglob = demandBnB[,.(demand_EJ = sum(demand_EJ)), by = .(year, aggr_mode)][, region:= "World"]

  demandBnBEU = demandBnB[region %in% EU_regions,.(demand_EJ = sum(demand_EJ)), by = .(year, aggr_mode)][, region:= "EUR"]

 demandBnBNEU = demandBnB[region %in% non_EU_regions,.(demand_EJ = sum(demand_EJ)), by = .(year, aggr_mode)][, region:= "NEU"]

  demandBnB = rbind(demandBnBglob,demandBnB,demandBnBEU,demandBnBNEU)

  cols2use=as.character(unique(demandBnB[,aggr_mode]))


  ptot1=ggplot()+
    geom_area(data = demandBnB[year > 2005 & year <= maxyear & region %in% EU_regions], aes(x=year, y=demand_EJ, group = aggr_mode, fill = aggr_mode), color = "black", position= position_stack())+
    facet_wrap(~region, nrow = 4, scales = "free")+
    labs(x = "", y = "Tot final energy demand [EJ]")+
    theme_minimal()+
     scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme(axis.text.x = element_text(angle = 90,  size = 7, vjust=0.5, hjust=1),
          axis.text.y = element_text(size=8),
          axis.title = element_text(size = 9),
          title = element_text(size = 9),
          legend.text = element_text(size = 9),
          legend.title = element_text(size =9),
          strip.text = element_text(size=9))

  ptot2=ggplot()+
    geom_area(data = demandBnB[year > 2005 & year <= maxyear & !region %in% EU_regions], aes(x=year, y=demand_EJ, group = aggr_mode, fill = aggr_mode), color = "black", position= position_stack())+
    facet_wrap(~region, nrow = 4, scales = "free")+
    labs(x = "", y = "Tot final energy demand [EJ]")+
    theme_minimal()+
     scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme(axis.text.x = element_text(angle = 90,  size = 7, vjust=0.5, hjust=1),
          axis.text.y = element_text(size=8),
          axis.title = element_text(size = 9),
          title = element_text(size = 9),
          legend.text = element_text(size = 9),
          legend.title = element_text(size =9),
          strip.text = element_text(size=9))


  return(list(ptot1 = ptot1, ptot2=ptot2))
}

## Final Energy demand
demEJ = demandBunkNoBunkplotf(demand_ej)
demEJ

```

# LDVs final energy demand

```{r, echo=FALSE, warning=FALSE, message=FALSE}
## demand EJ for LDV, divided by fuel type

demandEJLDVplotf <- function(demandEJ){
  demandEJ = demandEJ[subsector_L1 == "trn_pass_road_LDV_4W",]
  demandEJ <- demandEJ[, c("sector", "subsector_L3", "subsector_L2", "subsector_L1", "vehicle_type", "technology", "region", "year", "demand_EJ")]

  demandEJ[technology == "Hybrid Liquids", technology := "Liquids"]
  demandEJ[technology == "FCEV", technology := "Hydrogen"]
  demandEJ[technology == "BEV", technology := "Electricity"]
  demandEJ = demandEJ[, .(demand_EJ = sum(demand_EJ)), by = c("region", "year", "technology")]

  demandEJglob = demandEJ[, .(demand_EJ = sum(demand_EJ)), by = c("year", "technology")][, region := "World"]

  demandEJEUR = demandEJ[region %in% EU_regions, .(demand_EJ = sum(demand_EJ)), by = c("year", "technology")][, region := "EUR"]

  demandEJnonEUR = demandEJ[region %in% non_EU_regions, .(demand_EJ = sum(demand_EJ)), by = c("year", "technology")][, region := "NEU"]

  demandEJ = rbind(demandEJ, demandEJEUR, demandEJnonEUR, demandEJglob)
  cols2use = unique(as.character(demandEJ[, technology]))
  p1 = ggplot()+
    geom_area(data = demandEJ[year > 2005 & year <= maxyear  & region %in% c(EU_regions, NEU_regions) & year <= maxyear], aes(x=year, y=demand_EJ, group = technology, fill = technology), color="black",position= position_stack())+
    labs(x = "", y = "Final energy demand for LDVs, non-EU [EJ]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

  p2 = ggplot()+
    geom_area(data = demandEJ[year > 2005 & year <= maxyear  & region %in% c(non_EU_regions, "World", "EUR", "NEU") & year <= maxyear], aes(x=year, y=demand_EJ, group = technology, fill = technology), color="black",position= position_stack())+
    labs(x = "", y = "Final energy demand for LDVs [EJ]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

  return(list(p1,p2))

}


demandEJLDVplotf(demand_ej)
```

# Trucks final energy demand

```{r, echo=FALSE, warning=FALSE, message=FALSE}
## demand EJ for trucks, divided by fuel type

demandEJTruckplotf <- function(demandEJ){
  demandEJ = demandEJ[subsector_L3 == "trn_freight_road",]
  demandEJ <- demandEJ[, c("sector", "subsector_L3", "vehicle_type", "technology", "region", "year", "demand_EJ")]

  demandEJ[technology == "Hybrid Liquids", technology := "Liquids"]
  demandEJ[technology == "FCEV", technology := "Hydrogen"]
  demandEJ[technology == "BEV", technology := "Electricity"]
  demandEJ = demandEJ[, .(demand_EJ = sum(demand_EJ)), by = c("region", "year", "technology")]

  demandEJglob = demandEJ[, .(demand_EJ = sum(demand_EJ)), by = c("year", "technology")][, region := "World"]


   demandEJEUR = demandEJ[region %in% EU_regions, .(demand_EJ = sum(demand_EJ)), by = c("year", "technology")][, region := "EUR"]

  demandEJnonEUR = demandEJ[region %in% non_EU_regions, .(demand_EJ = sum(demand_EJ)), by = c("year", "technology")][, region := "NEU"]

  demandEJ = rbind(demandEJ, demandEJEUR, demandEJnonEUR, demandEJglob)
  cols2use = unique(as.character(demandEJ[, technology]))
  p1 = ggplot()+
    geom_area(data = demandEJ[year > 2005 & year <= maxyear & region %in% EU_regions & year <= maxyear], aes(x=year, y=demand_EJ, group = technology, fill = technology), color="black",position= position_stack())+
    labs(x = "", y = "Final energy demand for trucks [EJ]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

    p2 = ggplot()+
    geom_area(data = demandEJ[year > 2005 & year <= maxyear  & region %in% c(non_EU_regions, "EUR", "NEU", "World") & year <= maxyear], aes(x=year, y=demand_EJ, group = technology, fill = technology), color="black",position= position_stack())+
    labs(x = "", y = "Final energy demand for trucks [EJ]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

  return(list(p1, p2))

}


demandEJTruckplotf(demand_ej)
```

# Buses final energy demand

```{r, echo=FALSE, warning=FALSE, message=FALSE}
## demand EJ for trucks, divided by fuel type

demandEJBusplotf <- function(demandEJ){
  demandEJ = demandEJ[subsector_L2 == "Bus",]
  demandEJ <- demandEJ[, c("sector", "subsector_L3", "vehicle_type", "technology", "region", "year", "demand_EJ")]

  demandEJ[technology == "Hybrid Liquids", technology := "Liquids"]
  demandEJ[technology == "FCEV", technology := "Hydrogen"]
  demandEJ[technology == "BEV", technology := "Electricity"]
  demandEJ = demandEJ[, .(demand_EJ = sum(demand_EJ)), by = c("region", "year", "technology")]

  demandEJglob = demandEJ[, .(demand_EJ = sum(demand_EJ)), by = c("year", "technology")][, region := "World"]


   demandEJEUR = demandEJ[region %in% EU_regions, .(demand_EJ = sum(demand_EJ)), by = c("year", "technology")][, region := "EUR"]

  demandEJnonEUR = demandEJ[region %in% non_EU_regions, .(demand_EJ = sum(demand_EJ)), by = c("year", "technology")][, region := "NEU"]

  demandEJ = rbind(demandEJ, demandEJEUR, demandEJnonEUR, demandEJglob)
  cols2use = unique(as.character(demandEJ[, technology]))
  p1 = ggplot()+
    geom_area(data = demandEJ[year > 2005  & year <= maxyear & region %in% EU_regions & year <= maxyear], aes(x=year, y=demand_EJ, group = technology, fill = technology), color="black",position= position_stack())+
    labs(x = "", y = "Final energy demand for buses [EJ]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

    p2 = ggplot()+
    geom_area(data = demandEJ[year > 2005 & year <= maxyear  & region %in% c(non_EU_regions, "EUR", "NEU", "World") & year <= maxyear], aes(x=year, y=demand_EJ, group = technology, fill = technology), color="black",position= position_stack())+
    labs(x = "", y = "Final energy demand for buses [EJ]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

  return(list(p1, p2))

}


demandEJBusplotf(demand_ej)
```


# Trucks energy services demand

```{r, echo=FALSE, warning=FALSE, message=FALSE}
## demand EJ for trucks, divided by fuel type

demandkmTruckplotf <- function(demandkm){
  demandkm = demandkm[subsector_L3 == "trn_freight_road",]
  demandkm <- demandkm[, c("sector", "subsector_L3", "vehicle_type", "technology", "region", "year", "demand_F")]

  demandkm[technology == "Hybrid Liquids", technology := "Liquids"]
  demandkm[technology == "FCEV", technology := "Hydrogen"]
  demandkm[technology == "BEV", technology := "Electricity"]
  demandkm = demandkm[, .(demand_F = sum(demand_F)), by = c("region", "year", "technology")]

  demandkmglob = demandkm[, .(demand_F = sum(demand_F)), by = c("year", "technology")][, region := "World"]


   demandkmEUR = demandkm[region %in% EU_regions, .(demand_F = sum(demand_F)), by = c("year", "technology")][, region := "EUR"]

  demandkmnonEUR = demandkm[region %in% non_EU_regions, .(demand_F = sum(demand_F)), by = c("year", "technology")][, region := "NEU"]

  demandkm = rbind(demandkm, demandkmEUR, demandkmnonEUR, demandkmglob)
  cols2use = unique(as.character(demandkm[, technology]))
  p1 = ggplot()+
    geom_area(data = demandkm[year > 2005  & year <= maxyear & region %in% EU_regions & year <= maxyear], aes(x=year, y=demand_F, group = technology, fill = technology), color="black",position= position_stack())+
    labs(x = "", y = "Energy services demand for trucks [million tkm]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

    p2 = ggplot()+
    geom_area(data = demandkm[year > 2005 & year <= maxyear  & region %in% c(non_EU_regions, "EUR", "NEU", "World") & year <= maxyear], aes(x=year, y=demand_F, group = technology, fill = technology), color="black",position= position_stack())+
    labs(x = "", y = " Energy services demand for trucks [million tkm]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot


  return(list(p1, p2))

}


demandkmTruckplotf(demand_km)
```

# Buses energy services demand

```{r, echo=FALSE, warning=FALSE, message=FALSE}
## demand EJ for trucks, divided by fuel type

demandkmBusplotf <- function(demandkm){
  demandkm = demandkm[vehicle_type == "Bus_tmp_vehicletype",]
  demandkm <- demandkm[, c("sector", "subsector_L3", "vehicle_type", "technology", "region", "year", "demand_F")]

  demandkm[technology == "Hybrid Liquids", technology := "Liquids"]
  demandkm[technology == "FCEV", technology := "Hydrogen"]
  demandkm[technology == "BEV", technology := "Electricity"]
  demandkm = demandkm[, .(demand_F = sum(demand_F)), by = c("region", "year", "technology")]

  demandkmglob = demandkm[, .(demand_F = sum(demand_F)), by = c("year", "technology")][, region := "World"]


   demandkmEUR = demandkm[region %in% EU_regions, .(demand_F = sum(demand_F)), by = c("year", "technology")][, region := "EUR"]

  demandkmnonEUR = demandkm[region %in% non_EU_regions, .(demand_F = sum(demand_F)), by = c("year", "technology")][, region := "NEU"]

  demandkm = rbind(demandkm, demandkmEUR, demandkmnonEUR, demandkmglob)
  cols2use = unique(as.character(demandkm[, technology]))
  p1 = ggplot()+
    geom_area(data = demandkm[year > 2005  & year <= maxyear & region %in% EU_regions & year <= maxyear], aes(x=year, y=demand_F, group = technology, fill = technology), color="black",position= position_stack())+
    labs(x = "", y = "Energy services demand for buses [million tkm]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

    p2 = ggplot()+
    geom_area(data = demandkm[year > 2005 & year <= maxyear  & region %in% c(non_EU_regions, "EUR", "NEU", "World") & year <= maxyear], aes(x=year, y=demand_F, group = technology, fill = technology), color="black",position= position_stack())+
    labs(x = "", y = " Energy services demand for buses [million tkm]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot


  return(list(p1, p2))

}


demandkmBusplotf(demand_km)
```



# FE comparison IEA historical data vs EDGE-T projections


```{r, echo=FALSE, warning=FALSE, message=FALSE,fig.width = 10, fig.height = 5}
## demand EJ for trucks, divided by fuel type

demandEJ_IEAcomp <- function(demandEJ, IEA, demEJ_TRACCS, JRC_IDEES){
  demandEJ[, flow := ifelse(sector == "trn_aviation_intl", "AVBUNK", NA)]
  demandEJ[, flow := ifelse(sector == "trn_shipping_intl", "MARBUNK", flow)]
  demandEJ[, flow := ifelse(grepl("LDV", subsector_L2), "ROAD LDV", flow)]
  demandEJ[, flow := ifelse(grepl("Bus|freight_road", subsector_L2), "ROAD HDV", flow)]
  demandEJ[, flow := ifelse(grepl("Rail|HSR", subsector_L3), "RAIL", flow)]
  demandEJ[, flow := ifelse(grepl("Domestic Aviation", subsector_L3), "DOMESAIR", flow)]
  demandEJ[, flow := ifelse(grepl("Domestic Ship", subsector_L3), "DOMESNAV", flow)]
  demandEJ = demandEJ[,.(value = sum(demand_EJ)), by = c("region", "year", "flow")]

  demEJ_TRACCS[, flow := ifelse(vehicle_type %in% c("Large Car and SUV","Compact Car",  "Subcompact Car", "Midsize Car"), "ROAD LDV", NA)]
  demEJ_TRACCS[, flow := ifelse(!vehicle_type %in% c("Large Car and SUV","Compact Car",  "Subcompact Car", "Midsize Car"), "ROAD HDV", flow)]
  demEJ_TRACCS = demEJ_TRACCS[,.(value = sum(EJ)), by = c("region", "year", "flow")]

  demEJ_TRACCS[, model := "TRACCS"]
  demandEJ[, model := "EDGE-T"]
  IEA[, model := "IEAbal"]
  JRC_IDEES[, model := "JRC_IDEE"]
  totdem=rbind(demandEJ[year>=2015], IEA[year<2015],JRC_IDEES)
  totdem_road=rbind(demandEJ[year %in% c(2005, 2010, 2015)], IEA[year %in% c(2005, 2010, 2015)], demEJ_TRACCS, JRC_IDEES)
  cols2use = unique(as.character(totdem[flow%in%c("ROAD", "ROAD LDV", "ROAD HDV") & model %in% c("IEAbal", "EDGE-T"),flow]))
  p1 = ggplot()+
    geom_area(data = totdem[flow%in%c("ROAD", "ROAD LDV", "ROAD HDV") & region %in% EU_regions & year <= maxyear & model %in% c("IEAbal", "EDGE-T")], aes(x=year, y=value, group = interaction(model, flow), fill = flow), color="black",position= position_stack())+
    labs(x = "", y = "Final energy demand road [EJ]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

    p2 = ggplot()+
    geom_area(data = totdem[flow%in%c("ROAD", "ROAD LDV", "ROAD HDV") & !region %in% EU_regions & year <= maxyear & model %in% c("IEAbal", "EDGE-T")], aes(x=year, y=value, group = interaction(model, flow), fill = flow), color="black",position= position_stack())+
    labs(x = "", y = "Final energy demand road [EJ]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

    cols2use = unique(as.character(totdem[!flow%in%c("ROAD", "ROAD LDV", "ROAD HDV") & model %in% c("IEAbal", "EDGE-T"),flow]))

    p3 = ggplot()+
    geom_area(data = totdem[!flow%in%c("ROAD", "ROAD LDV", "ROAD HDV") & region %in% EU_regions & year <= maxyear & model %in% c("IEAbal", "EDGE-T") ], aes(x=year, y=value, group = interaction(model, flow), fill = flow), color="black",position= position_stack())+
    labs(x = "", y = "Final energy demand no road [EJ]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

    p4 = ggplot()+
    geom_area(data = totdem[!flow%in%c("ROAD", "ROAD LDV", "ROAD HDV") & !region %in% EU_regions & year <= maxyear & model %in% c("IEAbal", "EDGE-T")], aes(x=year, y=value, group = interaction(model, flow), fill = flow), color="black",position= position_stack())+
    labs(x = "", y = "Final energy demand no road [EJ]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

    totdem1=rbind(demandEJ, IEA, JRC_IDEES)

    cols2use = unique(as.character(totdem1[flow %in% c("ROAD", "ROAD LDV", "ROAD HDV"),flow]))

    p5b1 = ggplot()+
    geom_bar(data = totdem1[region %in% c("DEU", "FRA", "UKI") & year %in% c(2005, 2010, 2015) & flow %in% c("ROAD", "ROAD LDV", "ROAD HDV") & region %in% EU_regions], aes(x=model, y=value, group = interaction(model, flow), fill = flow), color="black", position="stack", stat = "identity", width = 0.5)+
    labs(x = "", y = "Final energy demand road [EJ]")+
    facet_grid(region~year, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

     p5b2 = ggplot()+
    geom_bar(data = totdem1[region %in% c("ECE", "ECS", "ENC") & year %in% c(2005, 2010, 2015) & flow %in% c("ROAD", "ROAD LDV", "ROAD HDV") & region %in% EU_regions], aes(x=model, y=value, group = interaction(model, flow), fill = flow), color="black", position="stack", stat = "identity", width = 0.5)+
    labs(x = "", y = "Final energy demand road [EJ]")+
    facet_grid(region~year, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot


    p5b3 = ggplot()+
    geom_bar(data = totdem1[region %in% c("ESC", "ESW", "EWN") & year %in% c(2005, 2010, 2015) & flow %in% c("ROAD", "ROAD LDV", "ROAD HDV") & region %in% EU_regions], aes(x=model, y=value, group = interaction(model, flow), fill = flow), color="black", position="stack", stat = "identity", width = 0.5)+
    labs(x = "", y = "Final energy demand road [EJ]")+
    facet_grid(region~year, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

    p6b1 = ggplot()+
    geom_bar(data = totdem1[year %in% c(2005, 2010, 2015) & flow %in% c("ROAD", "ROAD LDV", "ROAD HDV") & region %in% c("CHA", "IND", "OAS")], aes(x=model, y=value, group = interaction(model, flow), fill = flow), color="black", position="stack", stat = "identity", width = 0.5)+
    labs(x = "", y = "Final energy demand road [EJ]")+
    facet_grid(region~year, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

    p6b2 = ggplot()+
    geom_bar(data = totdem1[year %in% c(2005, 2010, 2015) & flow %in% c("ROAD", "ROAD LDV", "ROAD HDV") & region %in%c("CAZ", "USA", "LAM")], aes(x=model, y=value, group = interaction(model, flow), fill = flow), color="black", position="stack", stat = "identity", width = 0.5)+
    labs(x = "", y = "Final energy demand road [EJ]")+
    facet_grid(region~year, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot




    p6b3 = ggplot()+
    geom_bar(data = totdem1[year %in% c(2005, 2010, 2015) & flow %in% c("ROAD", "ROAD LDV", "ROAD HDV") & region %in% c("SSA", "MEA", "REF")], aes(x=model, y=value, group = interaction(model, flow), fill = flow), color="black", position="stack", stat = "identity", width = 0.5)+
    labs(x = "", y = "Final energy demand road [EJ]")+
    facet_grid(region~year, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot


    p6b4 = ggplot()+
    geom_bar(data = totdem1[year %in% c(2005, 2010, 2015) & flow %in% c("ROAD", "ROAD LDV", "ROAD HDV") & region %in% c("JPN", "NEN", "NES")], aes(x=model, y=value, group = interaction(model, flow), fill = flow), color="black", position="stack", stat = "identity", width = 0.5)+
    labs(x = "", y = "Final energy demand road [EJ]")+
    facet_grid(region~year, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot


    cols2use = unique(as.character(totdem1[!flow %in% c("ROAD", "ROAD LDV", "ROAD HDV"),flow]))

    p8b1 = ggplot()+
    geom_bar(data = totdem1[region %in% c("DEU", "UKI", "FRA") & year %in% c(2005, 2010, 2015) & !flow %in% c("ROAD", "ROAD LDV", "ROAD HDV")], aes(x=model, y=value, group = interaction(model, flow), fill = flow), color="black", position="stack", stat = "identity", width = 0.5)+
    labs(x = "", y = "Final energy demand no road [EJ]")+
    facet_grid(year~region, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot


    p8b2 = ggplot()+
    geom_bar(data = totdem1[region %in% c("ECE", "ECS", "ENC") & year %in% c(2005, 2010, 2015) & !flow %in% c("ROAD", "ROAD LDV", "ROAD HDV")], aes(x=model, y=value, group = interaction(model, flow), fill = flow), color="black", position="stack", stat = "identity", width = 0.5)+
    labs(x = "", y = "Final energy demand no road [EJ]")+
    facet_grid(year~region, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

    p8b3 = ggplot()+
    geom_bar(data = totdem1[region %in% c("ESC", "ESW", "EWN") & year %in% c(2005, 2010, 2015) & !flow %in% c("ROAD", "ROAD LDV", "ROAD HDV")], aes(x=model, y=value, group = interaction(model, flow), fill = flow), color="black", position="stack", stat = "identity", width = 0.5)+
    labs(x = "", y = "Final energy demand no road [EJ]")+
    facet_grid(year~region, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

    p8c1 = ggplot()+
    geom_bar(data = totdem1[year %in% c(2005, 2010, 2015) & !flow %in% c("ROAD", "ROAD LDV", "ROAD HDV") & region %in% c("CHA", "IND", "OAS")], aes(x=model, y=value, group = interaction(model, flow), fill = flow), color="black", position="stack", stat = "identity", width = 0.5)+
    labs(x = "", y = "Final energy demand no road [EJ]")+
    facet_grid(region~year, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot


    p8c2 = ggplot()+
    geom_bar(data = totdem1[year %in% c(2005, 2010, 2015) & !flow %in% c("ROAD", "ROAD LDV", "ROAD HDV") & region %in% c("CAZ", "USA", "LAM")], aes(x=model, y=value, group = interaction(model, flow), fill = flow), color="black", position="stack", stat = "identity", width = 0.5)+
    labs(x = "", y = "Final energy demand no road [EJ]")+
    facet_grid(region~year, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot


    p8c3 = ggplot()+
    geom_bar(data = totdem1[year %in% c(2005, 2010, 2015) & !flow %in% c("ROAD", "ROAD LDV", "ROAD HDV") & region %in% c("SSA", "MEA", "REF")], aes(x=model, y=value, group = interaction(model, flow), fill = flow), color="black", position="stack", stat = "identity", width = 0.5)+
    labs(x = "", y = "Final energy demand no road [EJ]")+
    facet_grid(region~year, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot


    p8c4 = ggplot()+
    geom_bar(data = totdem1[year %in% c(2005, 2010, 2015) & !flow %in% c("ROAD", "ROAD LDV", "ROAD HDV") & region %in% c("JPN", "NEN", "NES")], aes(x=model, y=value, group = interaction(model, flow), fill = flow), color="black", position="stack", stat = "identity", width = 0.5)+
    labs(x = "", y = "Final energy demand no road [EJ]")+
    facet_grid(region~year, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot


 ## EU as a whole region
    EU_totdem = rbind(demandEJ, IEA)
    EU_totdem = EU_totdem[region %in% c("DEU", "FRA", "UKI", "ECE", "ECS", "ENC", "ESC", "ESW", "EWN")]
    EU_totdem = EU_totdem[,.(value = sum(value)), by = c("model", "flow", "year")]
    names_flow = data.table(name = c("Shipping (Dom.)", "Aviation (Dom.)", "Shipping (Intl.)", "Aviation (Intl.)", "Road", "Road HDV", "Road LDV", "Rail"),
                            flow = c("DOMESNAV", "DOMESAIR", "MARBUNK", "AVBUNK", "ROAD", "ROAD HDV", "ROAD LDV", "RAIL"))
    EU_totdem = merge(EU_totdem, names_flow, by = "flow")
    cols2use  <- c(
          "Aviation (Intl.)" = "#9acd32",
          "Aviation (Dom.)" = "#7cfc00",
          "Rail" = "#2e8b57",
          "Road" = "#6495ed",
          "Road LDV" = "#1874cd",
          "Road HDV" = "#87cefa",
          "Shipping (Intl.)" = "#cd2626",
          "Shipping (Dom.)" = "#ff4040")


    p9c1 = ggplot()+
    geom_bar(data = EU_totdem[year %in% c(2005, 2010, 2015) & flow %in% c("ROAD", "ROAD LDV", "ROAD HDV") & model %in% c("IEAbal", "EDGE-T")], aes(x=model, y=value, group = interaction(model, name), fill = name), color="black", position="stack", stat = "identity", width = 0.5)+
    labs(x = "", y = "Final energy demand road [EJ]")+
    facet_grid(~year, scales = "free")+
    scale_fill_manual(name = "Mode", values = cols2use)+
    theme_plot

    p9c2 = ggplot()+
    geom_bar(data = EU_totdem[year %in% c(2005, 2010, 2015) & !flow %in% c("ROAD", "ROAD LDV", "ROAD HDV") & model %in% c("IEAbal", "EDGE-T")], aes(x=model, y=value, group = interaction(model, name), fill = name), color="black", position="stack", stat = "identity", width = 0.5)+
    labs(x = "", y = "Final energy demand, excluding road [EJ]")+
    facet_grid(~year, scales = "free")+
    scale_fill_manual(name = "Mode", values = cols2use)+
    theme_plot

    p9c3 = ggplot()+
    geom_bar(data = EU_totdem[year %in% c(2005, 2010, 2015)& model %in% c("IEAbal", "EDGE-T")], aes(x=model, y=value, group = interaction(model, name), fill = name), color="black", position="stack", stat = "identity", width = 0.5)+
    labs(x = "", y = "Final energy demand [EJ]")+
    facet_grid(~year, scales = "free")+
    scale_fill_manual(name = "Mode", values = cols2use)+
    theme_plot

    EU_totdem

  return(list(
    p1=p1,p2=p2,p3=p3,p4=p4,p5b1 = p5b1, p5b2=p5b2, p5b3=p5b3, p6b1=p6b1, p6b2=p6b2,p6b3=p6b3,p6b4=p6b4,p8b1=p8b1, p8b2=p8b2, p8b3=p8b3, p8c1=p8c1, p8c2=p8c2, p8c3=p8c3, p8c4=p8c4, p9c1 = p9c1, p9c2 = p9c2, p9c3 = p9c3
    ))

}


plots = demandEJ_IEAcomp(demand_ej, IEA, demEJ_TRACCS, JRC_IDEES)









```

# EU focus

```{r, echo=FALSE, warning=FALSE, message=FALSE,fig.width = 10, fig.height = 5}



print("Road transport, Europe")

plots$p1

print("Road transport, focus on DEU, FRA, UKI")

plots$p5b1

print("Road transport, focus on ECE, ECS, ENC")

plots$p5b2

print("Road transport, focus on ESC, ESW, EWN")


plots$p5b3

print("Transport w/o road, Europe")

plots$p3

print("Transport w/o road, focus on DEU, FRA, UKI")

plots$p8b1

print("Transport w/o road, focus on ECE, ECS, ENC")

plots$p8b2

print("Transport w/o road, focus on ESC, ESW, EWN")

plots$p8b3

print("Transport road, EUR")

plots$p9c1


print("Transport w/o road, EUR")

plots$p9c2


print("Transport, EUR")

plots$p9c3


```

# Non-EU focus

```{r, echo=FALSE, warning=FALSE, message=FALSE,fig.width = 10, fig.height = 5}

print("Road transport, non-Europe")

plots$p2

print("Road transport, focus on CHA, IND, OAS")

plots$p6b1

print("Road transport, focus on CAZ, USA, LAM")

plots$p6b2

print("Road transport, focus on SSA, MEA, REF")

plots$p6b3

print("Road transport, focus on JPN, NEN, NES")

plots$p6b4


print("Transport w/o road, non-Europe")

plots$p4

print("Transport w/o road, focus on CHA, IND, OAS")

plots$p8c1

print("Transport w/o road, focus on CAZ, USA, LAM")

plots$p8c2

print("Transport w/o road, focus on SSA, MEA, REF")

plots$p8c3

print("Transport w/o road, focus on JPN, NEN, NES")

plots$p8c4

print("Transport road, EUR")

plots$p9c1

print("Transport w/o road, EUR")

plots$p9c2

print("Transport, EUR")

plots$p9c3

```

# bunkers in EU (EDGE-T VS IEA)

```{r, echo=FALSE, warning=FALSE, message=FALSE}
bunk_EUplotf = function(bunk_EU, IEA){
  bunk_EU[, flow := ifelse(vehicle_type == "International Aviation_tmp_vehicletype", "AVBUNK", NA)]
  bunk_EU[, flow := ifelse(vehicle_type == "International Ship_tmp_vehicletype", "MARBUNK", flow)]
  bunk_EU[, model := "EDGE-T"]
  bunk_EU[, value := MJ *    ## in MJ
                     1e-12]   ## in EJ
  IEA = IEA[flow %in% c("AVBUNK", "MARBUNK") & region %in% EU_regions & year %in% c(1990, 2005, 2010),]
  IEA[, model := "IEAbal"]

  totbunk=rbind(bunk_EU[,c("region", "year", "flow", "model", "value")], IEA)

  cols2use = unique(as.character(totbunk[, flow]))

  p = ggplot()+
    geom_bar(data = totbunk, aes(x=model, y=value, group = interaction(model, flow), fill = flow), color="black", position="stack", stat = "identity", width = 0.5)+
    labs(x = "", y = "Final energy demand only bunkers [EJ]")+
    facet_grid(year~region, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

  return(p)

}

bunk_EUplotf(bunk_EU, IEA)

```

# share of alternative techs in ES demand (global values)

```{r, echo=FALSE, warning=FALSE, message=FALSE}
shareAltTechplotf = function(demandkm){
  ## REMIND-EDGE results
  demandkm<- demandkm[,c("subsector_L1","technology", "year","demand_F")]
  demandkm = demandkm[subsector_L1 %in% c("trn_pass_road_LDV_4W", "trn_freight_road_tmp_subsector_L1") & year >= 2005]
  demandkm[, aggr_mode := "LDV"]
  demandkm[subsector_L1 == "trn_freight_road_tmp_subsector_L1", aggr_mode := "Truck"]
  demandkm[, technology := ifelse(technology %in% c("BEV", "Electric", "FCEV", "Hybrid Electric"), "Alternative", "Conventional")]
  demandkm = demandkm[,.(demand_F = sum(demand_F)), by = c("year", "aggr_mode", "technology")]

  demandkm= demandkm[, share := demand_F/sum(demand_F), by = c("year", "aggr_mode")]

  demandkm[, aggr_mode := factor(aggr_mode, levels = c("LDV","Truck"))]

  cols2use = unique(as.character(demandkm[technology == "Alternative", aggr_mode]))

  p = ggplot()+
    geom_line(data = demandkm[technology == "Alternative" & year <= maxyear ], aes(x=year, y=share, color = aggr_mode))+
    labs(x = "", y = "Share [%] on km traveled")+
    facet_wrap(~aggr_mode)+
    theme_minimal()+
    scale_color_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot



  plots = list(p=p)
  return(plots)

}

## share of alternative veh on energy services demand
shareAltTechplotf(demand_km)
```

# Energy services demand

```{r, echo=FALSE, warning=FALSE, message=FALSE}
demandkmplotf = function(demandkm, POP){
  ## REMIND-EDGE results
  demandkm<- demandkm[,c("sector","subsector_L3","subsector_L2",
                         "subsector_L1","vehicle_type","technology", "region","year","demand_F")]
  demandkm[,demand_F:=demand_F   ## in millionkm
           *1e-6                      ## in trillion km
           ]
  ## attribute aggregated mode and vehicle names for plotting purposes, and aggregate
  demandkm[, aggr_mode := ifelse(subsector_L1 %in% c("Three-Wheeler", "trn_pass_road_LDV_4W"), "LDV", NA)]
  demandkm[, aggr_mode := ifelse(sector %in% c("trn_freight", "trn_shipping_intl"), "Freight", aggr_mode)]
  demandkm[, aggr_mode := ifelse(sector %in% c("trn_aviation_intl"), "Pass. non LDV", aggr_mode)]
  demandkm[, aggr_mode := ifelse(subsector_L2 %in% c("trn_pass_road_bus", "HSR_tmp_subsector_L2", "Passenger Rail_tmp_subsector_L2", "Cycle_tmp_subsector_L2", "Walk_tmp_subsector_L2", "Domestic Aviation_tmp_subsector_L2", "Bus") | subsector_L1 %in% c("trn_pass_road_LDV_2W"), "Pass. non LDV", aggr_mode)]

  demandkm[, veh := ifelse(grepl("Truck", vehicle_type) & vehicle_type != "Light Truck and SUV" | vehicle_type == "3W Rural", "Truck", NA)]
  demandkm[, veh := ifelse(grepl("Large|SUV|Midsize|Multipurpose Vehicle|Van|Light Truck and SUV", vehicle_type), "Large Cars", veh)]
  demandkm[, veh := ifelse(grepl("Subcompact|Compact|Mini", vehicle_type), "Small Cars", veh)]
  demandkm[, veh := ifelse(grepl("Motorcycle|Moped|Scooter", vehicle_type), "Motorbikes", veh)]
  demandkm[, veh := ifelse(grepl("bus|Bus", vehicle_type), "Bus", veh)]
  demandkm[, veh := ifelse(subsector_L3 == "Domestic Aviation", "Domestic Aviation", veh)]
  demandkm[, veh := ifelse(subsector_L3 == "International Aviation", "International Aviation", veh)]
  demandkm[, veh := ifelse(subsector_L3 == "Domestic Ship", "Domestic Shipping", veh)]
  demandkm[, veh := ifelse(subsector_L3 == "International Ship", "International Shipping", veh)]
  demandkm[, veh := ifelse(grepl("Freight Rail", vehicle_type), "Freight Rail", veh)]
  demandkm[, veh := ifelse(grepl("Passenger Rail|HSR", vehicle_type), "Passenger Rail", veh)]
  demandkm[, veh := ifelse(grepl("Ship", vehicle_type), "Shipping", veh)]
  demandkm[, veh := ifelse(grepl("Cycle|Walk", subsector_L3), "Non motorized", veh)]
  demandkm = demandkm[,.(demand_F = sum(demand_F)), by = c("region", "year", "aggr_mode", "veh")]
  setnames(demandkm, old = "veh", new = "vehicle_type")

  demandkm= demandkm[,.(demand_F = sum(demand_F)), by = c("region", "year", "aggr_mode", "vehicle_type")]

  demandkm[, vehicle_type_plot := factor(vehicle_type, levels = c("LDV","Truck",
                                                                  "Freight Rail",
                                                                  "Motorbikes", "Small Cars", "Large Cars", "Van",
                                                                  "Domestic Aviation", "International Aviation","Bus", "Passenger Rail",
                                                                  "Freight", "Non motorized", "Shipping"))]


  demandkm[, mode := ifelse(vehicle_type %in% c("Freight", "Freight Rail", "Truck", "Shipping"),"freight", "pass")]

  demandkm= demandkm[, .(demand_F = sum(demand_F)), by = c("region", "year", "vehicle_type_plot", "aggr_mode", "mode")]
  demandkmglob = demandkm[,.(demand_F = sum(demand_F)), by = .(year, vehicle_type_plot, aggr_mode, mode)][, region:= "World"]


   demandkmEUR = demandkm[region %in% EU_regions, .(demand_F = sum(demand_F)), by = .(year, vehicle_type_plot, aggr_mode, mode)][, region := "EUR"]

  demandkmnonEUR = demandkm[region %in% non_EU_regions, .(demand_F = sum(demand_F)), by =.(year, vehicle_type_plot, aggr_mode, mode)][, region := "NEU"]

  demandkm = rbind(demandkm, demandkmEUR, demandkmnonEUR, demandkmglob)


  ## calculate per capita demand
  POP = POP[, .(pop = sum(value)), by = c("region", "year")]
  demandkmcap = merge(demandkm[region!="World"], POP, all.x = TRUE, by =c("year", "region"))

  demandkmcapglob = demandkmcap[,.(demand_F = sum(demand_F), pop = sum(pop)), by = .(year, vehicle_type_plot, aggr_mode, mode)][, region:= "World"]

  demandkmcap = rbind(demandkmcap, demandkmcapglob)
  ## calculate per capita values
  demandkmcap = demandkmcap[order(aggr_mode)]
  demandkmcap[, cap_dem := demand_F*    ## in trillion km
                1e+6/        ## in million km
                pop]         ## in million km/million people=pkm/person


  demandkm = demandkm[order(aggr_mode)]

  cols2use = unique(as.character(demandkm[mode =="pass", vehicle_type_plot]))

  ptot_pass = ggplot()+
    geom_area(data = demandkm[mode =="pass"& year > 1980 & year <= maxyear  & region %in% EU_regions], aes(x=year, y=demand_F, group = interaction(vehicle_type_plot,aggr_mode), fill = vehicle_type_plot), color="black",position= position_stack())+
    labs(x = "", y = "Energy Services demand [trillion pkm]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    theme_minimal()+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

    ptot_pass2 = ggplot()+
    geom_area(data = demandkm[mode =="pass"& year > 1980 & year <= maxyear  & !region %in% EU_regions], aes(x=year, y=demand_F, group = interaction(vehicle_type_plot,aggr_mode), fill = vehicle_type_plot), color="black",position= position_stack())+
    labs(x = "", y = "Energy Services demand [trillion pkm]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    theme_minimal()+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

  cols2use = unique(as.character(demandkm[mode =="freight", vehicle_type_plot]))

  ptot_freight = ggplot()+
    geom_area(data = demandkm[mode =="freight"& year > 2005 & year <= maxyear  & region %in% EU_regions], aes(x=year, y=demand_F, group = interaction(vehicle_type_plot,aggr_mode), fill = vehicle_type_plot), color="black",position= position_stack())+
    labs(x = "", y = "Energy Services demand [trillion tkm]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    theme_minimal()+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

    ptot_freight1 = ggplot()+
    geom_area(data = demandkm[mode =="freight"& year > 2005 & year <= maxyear  & !region %in% EU_regions], aes(x=year, y=demand_F, group = interaction(vehicle_type_plot,aggr_mode), fill = vehicle_type_plot), color="black",position= position_stack())+
    labs(x = "", y = "Energy Services demand [trillion tkm]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot


    cols2use = unique(as.character(demandkm[mode =="freight", vehicle_type_plot]))

  pcap_freight1 = ggplot()+
    geom_area(data = demandkmcap[mode == "freight" & year >= 2005  & year <= maxyear & region %in% c(EU_regions, NEU_regions)], aes(x=year, y=cap_dem/1000, group = vehicle_type_plot, fill = vehicle_type_plot), color="black",position= position_stack())+
    labs(x = "", y = "Energy Services demand [ktkm/cap]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual("Vehicle Type", values = cols[match(cols2use, names(cols))])+
    scale_x_continuous(breaks = c(2020,2030,2050, maxyear))+
    theme_plot

    pcap_freight2 = ggplot()+
    geom_area(data = demandkmcap[mode == "freight" & year >= 2005  & year <= maxyear & region %in% c(non_EU_regions)], aes(x=year, y=cap_dem/1000, group = vehicle_type_plot, fill = vehicle_type_plot), color="black",position= position_stack())+
    labs(x = "", y = "Energy Services demand [ktkm/cap]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual("Vehicle Type", values = cols[match(cols2use, names(cols))])+
    scale_x_continuous(breaks = c(2020,2030,2050, maxyear))+
    theme_plot

    cols2use = unique(as.character(demandkm[mode =="pass", vehicle_type_plot]))

  pcap_pass = ggplot()+
    geom_area(data = demandkmcap[mode == "pass" & year >= 2005 & year <= maxyear & region %in% c(EU_regions)], aes(x=year, y=cap_dem/1000, group = vehicle_type_plot, fill = vehicle_type_plot), color="black",position= position_stack())+
    labs(x = "", y = "Energy Services demand [kpkm/cap]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual("Vehicle Type", values = cols[match(cols2use, names(cols))])+
    scale_x_continuous(breaks = c(2020, 2030, 2050, maxyear))+
    theme_plot

  pcap_pass2 = ggplot()+
    geom_area(data = demandkmcap[mode == "pass" & year >= 2005 & year <= maxyear & region %in% c(non_EU_regions)], aes(x=year, y=cap_dem/1000, group = vehicle_type_plot, fill = vehicle_type_plot), color="black",position= position_stack())+
    labs(x = "", y = "Energy Services demand [kpkm/cap]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual("Vehicle Type", values = cols[match(cols2use, names(cols))])+
    scale_x_continuous(breaks = c(2020, 2030, 2050, maxyear))



  plots = list(ptot_pass = ptot_pass,ptot_pass2 = ptot_pass2, ptot_freight = ptot_freight, ptot_freight1 = ptot_freight1, pcap_pass = pcap_pass, pcap_pass2 = pcap_pass2, pcap_freight1 = pcap_freight1, pcap_freight2 = pcap_freight2)
  return(plots)

}

## energy services demand
demandkmplotf(demand_km, POP)
```

# Energy services demand (no bunkers)

```{r, echo=FALSE, warning=FALSE, message=FALSE}
demandkm_nobunk_plotf = function(demandkm, POP){
  ## REMIND-EDGE results
  demandkm<- demandkm[,c("sector","subsector_L3","subsector_L2",
                         "subsector_L1","vehicle_type","technology", "region","year","demand_F")]
  demandkm[,demand_F:=demand_F   ## in millionkm
           *1e-6                      ## in trillion km
           ]

  demandkm = demandkm[!sector %in% c("trn_shipping_intl", "trn_aviation_intl")]
  ## attribute aggregated mode and vehicle names for plotting purposes, and aggregate
  demandkm[, aggr_mode := ifelse(subsector_L1 %in% c("Three-Wheeler", "trn_pass_road_LDV_4W"), "LDV", NA)]
  demandkm[, aggr_mode := ifelse(sector %in% c("trn_freight", "trn_shipping_intl"), "Freight", aggr_mode)]
  demandkm[, aggr_mode := ifelse(sector %in% c("trn_aviation_intl"), "Pass. non LDV", aggr_mode)]
  demandkm[, aggr_mode := ifelse(subsector_L2 %in% c("trn_pass_road_bus", "HSR_tmp_subsector_L2", "Passenger Rail_tmp_subsector_L2", "Cycle_tmp_subsector_L2", "Walk_tmp_subsector_L2", "Domestic Aviation_tmp_subsector_L2", "Bus") | subsector_L1 %in% c("trn_pass_road_LDV_2W"), "Pass. non LDV", aggr_mode)]

  demandkm[, veh := ifelse(grepl("Truck", vehicle_type) & vehicle_type != "Light Truck and SUV" | vehicle_type == "3W Rural", "Truck", NA)]
  demandkm[, veh := ifelse(grepl("Large|SUV|Midsize|Multipurpose Vehicle|Van|Light Truck and SUV", vehicle_type), "Large Cars", veh)]
  demandkm[, veh := ifelse(grepl("Subcompact|Compact|Mini", vehicle_type), "Small Cars", veh)]
  demandkm[, veh := ifelse(grepl("Motorcycle|Moped|Scooter", vehicle_type), "Motorbikes", veh)]
  demandkm[, veh := ifelse(grepl("bus|Bus", vehicle_type), "Bus", veh)]
  demandkm[, veh := ifelse(subsector_L3 == "Domestic Aviation", "Domestic Aviation", veh)]
  demandkm[, veh := ifelse(subsector_L3 == "Domestic Ship", "Domestic Shipping", veh)]
  demandkm[, veh := ifelse(grepl("Freight Rail", vehicle_type), "Freight Rail", veh)]
  demandkm[, veh := ifelse(grepl("Passenger Rail|HSR", vehicle_type), "Passenger Rail", veh)]
  demandkm[, veh := ifelse(grepl("Ship", vehicle_type), "Dom. Shipping", veh)]
  demandkm[, veh := ifelse(grepl("Cycle|Walk", subsector_L3), "Non motorized", veh)]
  demandkm = demandkm[,.(demand_F = sum(demand_F)), by = c("region", "year", "aggr_mode", "veh")]
  setnames(demandkm, old = "veh", new = "vehicle_type")

  demandkm= demandkm[,.(demand_F = sum(demand_F)), by = c("region", "year", "aggr_mode", "vehicle_type")]

  demandkm[, vehicle_type_plot := factor(vehicle_type, levels = c("LDV","Truck",
                                                                  "Freight Rail",
                                                                  "Motorbikes", "Small Cars", "Large Cars", "Van",
                                                                  "Domestic Aviation", "Bus", "Passenger Rail",
                                                                  "Freight", "Non motorized", "Dom. Shipping"))]


  demandkm[, mode := ifelse(vehicle_type %in% c("Freight", "Freight Rail", "Truck", "Dom. Shipping"),"freight", "pass")]

  demandkm= demandkm[, .(demand_F = sum(demand_F)), by = c("region", "year", "vehicle_type_plot", "aggr_mode", "mode")]
  demandkmglob = demandkm[,.(demand_F = sum(demand_F)), by = .(year, vehicle_type_plot, aggr_mode, mode)][, region:= "World"]


   demandkmEUR = demandkm[region %in% EU_regions, .(demand_F = sum(demand_F)), by = .(year, vehicle_type_plot, aggr_mode, mode)][, region := "EUR"]

  demandkmnonEUR = demandkm[region %in% non_EU_regions, .(demand_F = sum(demand_F)), by =.(year, vehicle_type_plot, aggr_mode, mode)][, region := "NEU"]

  demandkm = rbind(demandkm, demandkmEUR, demandkmnonEUR, demandkmglob)


  ## calculate per capita demand
  POP = POP[, .(pop = sum(value)), by = c("region", "year")]
  demandkmcap = merge(demandkm[region!="World"], POP, all.x = TRUE, by =c("year", "region"))

  demandkmcapglob = demandkmcap[,.(demand_F = sum(demand_F), pop = sum(pop)), by = .(year, vehicle_type_plot, aggr_mode, mode)][, region:= "World"]

  demandkmcap = rbind(demandkmcap, demandkmcapglob)
  ## calculate per capita values
  demandkmcap = demandkmcap[order(aggr_mode)]
  demandkmcap[, cap_dem := demand_F*    ## in trillion km
                1e+6/        ## in million km
                pop]         ## in million km/million people=pkm/person


  demandkm = demandkm[order(aggr_mode)]

  cols2use = unique(as.character(demandkm[mode =="pass", vehicle_type_plot]))

  ptot_pass = ggplot()+
    geom_area(data = demandkm[mode =="pass"& year > 1980 & year <= maxyear  & region %in% EU_regions], aes(x=year, y=demand_F, group = interaction(vehicle_type_plot,aggr_mode), fill = vehicle_type_plot), color="black",position= position_stack())+
    labs(x = "", y = "Energy Services demand [trillion pkm]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    theme_minimal()+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

  ptot_pass2 = ggplot()+
    geom_area(data = demandkm[mode =="pass"& year > 1980 & year <= maxyear  & !region %in% EU_regions], aes(x=year, y=demand_F, group = interaction(vehicle_type_plot,aggr_mode), fill = vehicle_type_plot), color="black",position= position_stack())+
    labs(x = "", y = "Energy Services demand [trillion pkm]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    theme_minimal()+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

  cols2use = unique(as.character(demandkm[mode =="freight", vehicle_type_plot]))
  ptot_freight = ggplot()+
    geom_area(data = demandkm[mode =="freight"& year > 2005 & year <= maxyear  & region %in% EU_regions], aes(x=year, y=demand_F, group = interaction(vehicle_type_plot,aggr_mode), fill = vehicle_type_plot), color="black",position= position_stack())+
    labs(x = "", y = "Energy Services demand [trillion tkm]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    theme_minimal()+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

    ptot_freight1 = ggplot()+
    geom_area(data = demandkm[mode =="freight"& year > 2005 & year <= maxyear  & !region %in% EU_regions], aes(x=year, y=demand_F, group = interaction(vehicle_type_plot,aggr_mode), fill = vehicle_type_plot), color="black",position= position_stack())+
    labs(x = "", y = "Energy Services demand [trillion tkm]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    theme_plot

  pcap_freight1 = ggplot()+
    geom_area(data = demandkmcap[mode == "freight" & year >= 2005  & year <= maxyear & region %in% c(EU_regions, NEU_regions)], aes(x=year, y=cap_dem/1000, group = vehicle_type_plot, fill = vehicle_type_plot), color="black",position= position_stack())+
    labs(x = "", y = "Energy Services demand [ktkm/cap]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual("Vehicle Type", values = cols[match(cols2use, names(cols))])+
    scale_x_continuous(breaks = c(2020,2030,2050, maxyear))+
    theme_plot

    pcap_freight2 = ggplot()+
    geom_area(data = demandkmcap[mode == "freight" & year >= 2005  & year <= maxyear & region %in% c(non_EU_regions)], aes(x=year, y=cap_dem/1000, group = vehicle_type_plot, fill = vehicle_type_plot), color="black",position= position_stack())+
    labs(x = "", y = "Energy Services demand [ktkm/cap]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual("Vehicle Type", values = cols[match(cols2use, names(cols))])+
    scale_x_continuous(breaks = c(2020,2030,2050, maxyear))+
    theme_plot

  cols2use = unique(as.character(demandkm[mode =="pass", vehicle_type_plot]))
  pcap_pass = ggplot()+
    geom_area(data = demandkmcap[mode == "pass" & year >= 2005 & year <= maxyear & region %in% c(EU_regions)], aes(x=year, y=cap_dem/1000, group = vehicle_type_plot, fill = vehicle_type_plot), color="black",position= position_stack())+
    labs(x = "", y = "Energy Services demand [kpkm/cap]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual("Vehicle Type", values = cols[match(cols2use, names(cols))])+
    scale_x_continuous(breaks = c(2020, 2030, 2050, maxyear))+
    theme_plot

  pcap_pass2 = ggplot()+
    geom_area(data = demandkmcap[mode == "pass" & year >= 2005 & year <= maxyear & region %in% c(non_EU_regions)], aes(x=year, y=cap_dem/1000, group = vehicle_type_plot, fill = vehicle_type_plot), color="black",position= position_stack())+
    labs(x = "", y = "Energy Services demand [kpkm/cap]")+
    facet_wrap(~region, nrow = 4, scales = "free")+
    scale_fill_manual("Vehicle Type", values = cols[match(cols2use, names(cols))])+
    scale_x_continuous(breaks = c(2020, 2030, 2050, maxyear))+
    theme_plot



  plots = list(ptot_pass = ptot_pass,ptot_pass2 = ptot_pass2, ptot_freight = ptot_freight, ptot_freight1 = ptot_freight1, pcap_pass = pcap_pass, pcap_pass2 = pcap_pass2, pcap_freight1 = pcap_freight1, pcap_freight2 = pcap_freight2)
  return(plots)

}

## energy services demand
demandkm_nobunk_plotf(demand_km, POP)
```


# LDVs vintages

```{r, echo=FALSE, warning=FALSE, message=FALSE}
plotVintLDV = function(vintcomp, newcomp, sharesVS1, loadFactor, annual_mileage){
  # browser()
  vintcomp = vintcomp[,.(totdem, region, subsector_L1, year, technology,vehicle_type, sector, sharetech_vint)]
  newcomp = newcomp[,.(region, subsector_L1, year, technology,vehicle_type, sector, sharetech_new)]
  allfleet = merge(newcomp, vintcomp, all =TRUE, by = c("region", "sector", "subsector_L1", "vehicle_type", "technology",  "year"))
  allfleet = allfleet[sector=="trn_pass"]
  allfleet = merge(allfleet, sharesVS1[,.(shareVS1 = share, region, year, vehicle_type, subsector_L1)], all.x=TRUE, by = c("region", "year", "vehicle_type", "subsector_L1"))
  allfleet[,vintdem:=totdem*sharetech_vint*shareVS1]
  allfleet[,newdem:=totdem*sharetech_new*shareVS1]
  allfleet=melt(allfleet, id.vars = c("region", "sector", "subsector_L1", "vehicle_type", "technology",
                                      "year"), measure.vars = c("vintdem", "newdem"))
  allfleet[,alpha:=ifelse(variable == "vintdem", 0, 1)]
  allfleet = merge(allfleet, loadFactor, by = c("region", "year", "sector", "subsector_L1", "vehicle_type", "technology"))
  allfleet = merge(allfleet, annual_mileage, by = c("region", "year", "sector", "subsector_L1", "vehicle_type", "technology"))

   fleetcomp =allfleet[,.(value = sum(value/loadFactor/vkm.veh)), by = c("region", "year", "vehicle_type")]
  pfleetcomp = ggplot()+
  geom_line(data = fleetcomp[year < maxyear & region %in% EU_regions],
  aes(x=as.character(year),y=value, group=vehicle_type,
  color = vehicle_type))+
  facet_wrap(~region, scales = "free")+
  labs(y = "Fleet by vehicle type [million Veh]", x="")+
  theme_plot


  allfleet = allfleet[,.(value = sum(value/loadFactor/vkm.veh)), by = c("region", "technology", "variable", "year")]
  allfleet = allfleet[,.(value = sum(value)), by = c("region", "technology", "variable", "year")]
  allfleet[,alphaval := ifelse(variable =="vintdem", 1,0)]
  allfleet_glob = allfleet[,.(value = sum(value)), by = c("technology", "variable", "year", "alphaval")][, region:= "World"]

  allfleet_EU = allfleet[region %in% EU_regions,.(value = sum(value)), by = c("technology", "variable", "year", "alphaval")][, region:= "EUR"]

  allfleet = rbind(allfleet, allfleet_glob, allfleet_EU)
  cols2use = unique(as.character(allfleet[,technology]))
  p1 = ggplot()+
  geom_bar(data = allfleet[year %in% c(2015, 2030, 2050, maxyear) & region %in% EU_regions],
  aes(x=as.character(year),y=value, group=interaction(variable, technology),
  fill = technology), alpha = 0.5, position="stack", stat = "identity", width = 0.5)+
  geom_bar(data = allfleet[year %in% c(2015, 2030, 2050, maxyear) & region %in% EU_regions],
  aes(x=as.character(year),y=value, group=interaction(variable, technology),
  fill = technology, alpha = factor(alphaval)), position="stack", stat = "identity", width = 0.5, color = "black", size = 0.05)+
  guides(fill = guide_legend(reverse=TRUE))+
    facet_wrap(~region, nrow = 4,scales = "free")+
      scale_x_discrete(breaks = c(2015, 2030, 2050, maxyear))+
  scale_alpha_discrete(breaks = c(1,0), name = "Status", labels = c("Vintages","New additions")) +
  guides(linetype=FALSE,
         fill=guide_legend(reverse=FALSE, title="Transport mode"))+
  scale_fill_manual(values = cols[match(cols2use, names(cols))])+
  labs(y = "LDV fleet [million Veh]", x="")+
    theme_plot
    p2 = ggplot()+
  geom_bar(data = allfleet[year %in% c(2015, 2030, 2050, maxyear) & region %in% c(NEU_regions, non_EU_regions, "World", "EUR")],
  aes(x=as.character(year),y=value, group=interaction(variable, technology),
  fill = technology), alpha = 0.5, position="stack", stat = "identity", width = 0.5)+
  geom_bar(data = allfleet[year %in% c(2015, 2030, 2050, maxyear) & region %in% c(NEU_regions, non_EU_regions, "World", "EUR")],
  aes(x=as.character(year),y=value, group=interaction(variable, technology),
  fill = technology, alpha = factor(alphaval)), position="stack", stat = "identity", width = 0.5, color = "black", size = 0.05)+
  guides(fill = guide_legend(reverse=TRUE))+
    facet_wrap(~region, nrow = 4,scales = "free")+
      scale_x_discrete(breaks = c(2015, 2030, 2050, maxyear))+
  scale_alpha_discrete(breaks = c(1,0), name = "Status", labels = c("Vintages","New additions")) +
  guides(linetype=FALSE,
         fill=guide_legend(reverse=FALSE, title="Transport mode"))+
  scale_fill_manual(values = cols[match(cols2use, names(cols))])+
  labs(y = "LDV fleet [million Veh]", x="")+
  theme_plot



  return(list(p1,p2, pfleetcomp))
  }
p = plotVintLDV(vintcomp[subsector_L1 == "trn_pass_road_LDV_4W"], newcomp[subsector_L1 == "trn_pass_road_LDV_4W"], sharesVS1 = shares$VS1_shares, loadFactor, annual_mileage)
p
```

# Trucks and buses vintages

```{r, echo=FALSE, warning=FALSE, message=FALSE}
plotVintTruckBus = function(vintcomp, newcomp, sharesVS1, loadFactor){
  vint = copy(vintcomp)
  new = copy(newcomp)
  vint = vint[,.(totdem, region, subsector_L1, year, technology,vehicle_type, sector, sharetech_vint)]
  new = new[,.(region, subsector_L1, year, technology,vehicle_type, sector, sharetech_new)]
  allfleet = merge(new, vint, all =TRUE, by = c("region", "sector", "subsector_L1", "vehicle_type", "technology",  "year"))
  allfleet = allfleet[subsector_L1%in%c("trn_freight_road_tmp_subsector_L1","Bus_tmp_subsector_L1")]
  allfleet = merge(allfleet, sharesVS1[,.(shareVS1 = share, region, year, vehicle_type, subsector_L1)], all.x=TRUE, by = c("region", "year", "vehicle_type", "subsector_L1"))
  allfleet[,vintdem:=totdem*sharetech_vint*shareVS1]
  allfleet[,newdem:=totdem*sharetech_new*shareVS1]
  allfleet=melt(allfleet, id.vars = c("region", "sector", "subsector_L1", "vehicle_type", "technology",
                                      "year"), measure.vars = c("vintdem", "newdem"))
  allfleet[,alpha:=ifelse(variable == "vintdem", 0, 1)]
  allfleet = merge(allfleet, loadFactor, by = c("region", "year", "sector", "subsector_L1", "vehicle_type", "technology"))
  fleetcomp =allfleet[,.(value = sum(value/loadFactor/50000)), by = c("region", "year", "vehicle_type")]
  pfleetcomp = ggplot()+
  geom_line(data = fleetcomp[year < maxyear & region %in% EU_regions],
  aes(x=as.character(year),y=value, group=vehicle_type,
  color = vehicle_type))+
  facet_wrap(~region, scales = "free")+
  labs(y = "Fleet by vehicle type [million Veh]", x="")+
  theme_plot
  allfleet = allfleet[,.(value = sum(value/loadFactor/50000)), by = c("region", "technology", "variable", "year", "subsector_L1")]
  allfleet = allfleet[,.(value = sum(value)), by = c("region", "technology", "variable", "year", "subsector_L1")]
  allfleet[,alphaval := ifelse(variable =="vintdem", 1,0)]
  allfleet_glob = allfleet[,.(value = sum(value)), by = c("technology", "variable", "year", "alphaval", "subsector_L1")][, region:= "World"]
  allfleet = rbind(allfleet, allfleet_glob)
  cols2use = unique(as.character(allfleet[,technology]))
  p1_truck = ggplot()+
  geom_bar(data = allfleet[year %in% c(2015, 2030, 2050, maxyear) & region %in% EU_regions & subsector_L1 == "trn_freight_road_tmp_subsector_L1"],
  aes(x=as.character(year),y=value, group=interaction(variable, technology),
  fill = technology), alpha = 0.5, position="stack", stat = "identity", width = 0.5)+
  geom_bar(data = allfleet[year %in% c(2015, 2030, 2050, maxyear) & region %in% EU_regions& subsector_L1 == "trn_freight_road_tmp_subsector_L1"],
  aes(x=as.character(year),y=value, group=interaction(variable, technology),
  fill = technology, alpha = factor(alphaval)), position="stack", stat = "identity", width = 0.5, color = "black", size = 0.05)+
  guides(fill = guide_legend(reverse=TRUE))+
    facet_wrap(~region, nrow = 4,scales = "free")+
      scale_x_discrete(breaks = c(2015, 2030, 2050, maxyear))+
  scale_alpha_discrete(breaks = c(1,0), name = "Status", labels = c("Vintages","New additions")) +
  guides(linetype=FALSE,
         fill=guide_legend(reverse=FALSE, title="Transport mode"))+
  scale_fill_manual(values = cols[match(cols2use, names(cols))])+
  labs(y = "Truck fleet [million Veh]", x="")+
    theme_plot
    p2_truck = ggplot()+
  geom_bar(data = allfleet[year %in% c(2015, 2030, 2050, maxyear) & region %in% c(NEU_regions, non_EU_regions)& subsector_L1 == "trn_freight_road_tmp_subsector_L1"],
  aes(x=as.character(year),y=value, group=interaction(variable, technology),
  fill = technology), alpha = 0.5, position="stack", stat = "identity", width = 0.5)+
  geom_bar(data = allfleet[year %in% c(2015, 2030, 2050, maxyear) & region %in% c(NEU_regions, non_EU_regions)& subsector_L1 == "trn_freight_road_tmp_subsector_L1"],
  aes(x=as.character(year),y=value, group=interaction(variable, technology),
  fill = technology, alpha = factor(alphaval)), position="stack", stat = "identity", width = 0.5, color = "black", size = 0.05)+
  guides(fill = guide_legend(reverse=TRUE))+
    facet_wrap(~region, nrow = 4,scales = "free")+
      scale_x_discrete(breaks = c(2015, 2030, 2050, maxyear))+
  scale_alpha_discrete(breaks = c(1,0), name = "Status", labels = c("Vintages","New additions")) +
  guides(linetype=FALSE,
         fill=guide_legend(reverse=FALSE, title="Transport mode"))+
  scale_fill_manual(values = cols[match(cols2use, names(cols))])+
  labs(y = "Truck fleet [million Veh]", x="")+
  theme_plot
  p1_bus = ggplot()+
  geom_bar(data = allfleet[year %in% c(2015, 2030, 2050, maxyear) & region %in% EU_regions & subsector_L1 == "Bus_tmp_subsector_L1"],
  aes(x=as.character(year),y=value, group=interaction(variable, technology),
  fill = technology), alpha = 0.5, position="stack", stat = "identity", width = 0.5)+
  geom_bar(data = allfleet[year %in% c(2015, 2030, 2050, maxyear) & region %in% EU_regions& subsector_L1 == "Bus_tmp_subsector_L1"],
  aes(x=as.character(year),y=value, group=interaction(variable, technology),
  fill = technology, alpha = factor(alphaval)), position="stack", stat = "identity", width = 0.5, color = "black", size = 0.05)+
  guides(fill = guide_legend(reverse=TRUE))+
    facet_wrap(~region, nrow = 4,scales = "free")+
      scale_x_discrete(breaks = c(2015, 2030, 2050, maxyear))+
  scale_alpha_discrete(breaks = c(1,0), name = "Status", labels = c("Vintages","New additions")) +
  guides(linetype=FALSE,
         fill=guide_legend(reverse=FALSE, title="Transport mode"))+
  scale_fill_manual(values = cols[match(cols2use, names(cols))])+
  labs(y = "Bus fleet [million Veh]", x="")+
    theme_plot
  p2_bus = ggplot()+
  geom_bar(data = allfleet[year %in% c(2015, 2030, 2050, maxyear) & region %in% c(NEU_regions, non_EU_regions)& subsector_L1 == "Bus_tmp_subsector_L1"],
  aes(x=as.character(year),y=value, group=interaction(variable, technology),
  fill = technology), alpha = 0.5, position="stack", stat = "identity", width = 0.5)+
  geom_bar(data = allfleet[year %in% c(2015, 2030, 2050, maxyear) & region %in% c(NEU_regions, non_EU_regions)& subsector_L1 == "Bus_tmp_subsector_L1"],
  aes(x=as.character(year),y=value, group=interaction(variable, technology),
  fill = technology, alpha = factor(alphaval)), position="stack", stat = "identity", width = 0.5, color = "black", size = 0.05)+
  guides(fill = guide_legend(reverse=TRUE))+
    facet_wrap(~region, nrow = 4,scales = "free")+
      scale_x_discrete(breaks = c(2015, 2030, 2050, maxyear))+
  scale_alpha_discrete(breaks = c(1,0), name = "Status", labels = c("Vintages","New additions")) +
  guides(linetype=FALSE,
         fill=guide_legend(reverse=FALSE, title="Transport mode"))+
  scale_fill_manual(values = cols[match(cols2use, names(cols))])+
  labs(y = "Bus fleet [million Veh]", x="")+
  theme_plot
  return(list(p1_truck,p2_truck,p1_bus,p2_bus, pfleetcomp))
}
p = plotVintTruckBus(vintcomp, newcomp, sharesVS1 = shares$VS1_shares, loadFactor)
p
```

# Sales LDVs

```{r, echo=FALSE, warning=FALSE}
SalesFun = function(shares_LDV, newcomp, sharesVS1){
  # browser()
  ## I need the total demand for each region to get the average composition in the region (sales are on a country level)
  ## First I calculate the total demand for new sales using the shares on FV level (in newcomp) and on VS1 level
  newcomp = merge(newcomp, sharesVS1[,.(shareVS1 = share, region, year, vehicle_type, subsector_L1)], all.x=TRUE, by = c("region", "year", "vehicle_type", "subsector_L1"))
  newcomp[, newdem := totdem*sharetech_new*shareVS1]
  newcomp = newcomp[,.(value = sum(newdem)), by = c("region", "year", "subsector_L1")]
  ## I have to interpolate in time the sales nto to loose the sales composition annual values
  newcomp=approx_dt(dt=newcomp, unique(shares_LDV$year),
                    xcol= "year",
                    ycol = "value",
                    idxcols=c("region","subsector_L1"),
                    extrapolate=T)
  setnames(newcomp, new = "newdem", old = "value")
  ## I calculate the sales composition (disrespective to the vehicle type)
  shares_LDV = unique(shares_LDV[,c("region","year", "technology", "shareFS1")])
  shares_LDV <- shares_LDV[,.(shareFS1=sum(shareFS1)),by=c("region","technology","year")]
  ## I calculate the weighted regional sales (depending on the total volume of sales per country in each region)
  shares_LDV = merge(shares_LDV, newcomp)
  shares_LDV[, demfuel := shareFS1*newdem, by = c("year", "region", "technology")]
  shares_LDV = shares_LDV[, .(demfuel = sum(demfuel)), by = c("year", "region", "technology")]
  shares_LDV[, shareFS1 := demfuel/sum(demfuel), by = c("year", "region")]
  ## plot features
  shares_LDV[, technology := factor(technology, levels = c("BEV", "Hybrid Electric", "FCEV", "Liquids", "NG"))]
  cols2use = unique(as.character(shares_LDV[,technology]))
  plot = ggplot()+
    geom_bar(data = shares_LDV[year<=2060], aes(x=as.numeric(as.character(year)),y=shareFS1, group = technology, fill = technology), position = position_stack(), stat = "identity")+
   facet_wrap(~region, nrow = 4,scales = "free")+
    theme_plot +
  scale_fill_manual(values = cols[match(cols2use, names(cols))])+
    expand_limits(y = c(0,1))+
    scale_x_continuous(breaks = c(2015, 2030, 2050, 2060))+
    labs(x = "", y = "[%]", title = "Market share of new LDV sales")
  return(plot)
}
SalesFun(annual_sale, newcomp[subsector_L1=="trn_pass_road_LDV_4W"], shares$VS1_shares[subsector_L1=="trn_pass_road_LDV_4W"])
```


# Energy intensity for selected LDVs

```{r, echo=FALSE, warning=FALSE}

plotEnInt = function(mj_km, vt){
  cols2use = unique(as.character(mj_km[subsector_L1 == "trn_pass_road_LDV_4W" & vehicle_type == vt,technology]))
  p=ggplot()+
    geom_line(data = mj_km[subsector_L1 == "trn_pass_road_LDV_4W" & vehicle_type == vt & year<=maxyear & year>=2010], aes(x = as.character(year), y = MJ_km, group = technology, color = technology), size = 1)+
    facet_wrap(~region, nrow = 3, scales = "free")+
    expand_limits(y = c(0,0.8))+
    scale_x_discrete(breaks = c(2015,2050,maxyear))+
    scale_color_manual(values = cols[match(cols2use, names(cols))])+
    labs(x = "", y = "Energy intensity [MJ/km]", title = paste0("Example of ", vt))+
    theme_plot

  return(p)
}

plotEnInt(mj_km = mj_km_data, vt = "Large Car and SUV")
plotEnInt(mj_km = mj_km_data, vt = "Midsize Car")
plotEnInt(mj_km = mj_km_data, vt = "Subcompact Car")
```


# Costs for selected vehicle types

```{r, echo=FALSE, warning=FALSE}

plotCost = function(costs, vt){
  cols2use = unique(as.character(costs[vehicle_type == vt,technology]))
  p=ggplot()+
    geom_line(data = costs[vehicle_type == vt & year<=maxyear & year>=2010], aes(x = as.character(year), y = non_fuel_price, group = technology, color = technology), size = 1)+
    facet_wrap(~region, nrow = 3, scales = "free")+
    expand_limits(y = c(0,0.5))+
    scale_x_discrete(breaks = c(2015,2050,maxyear))+
    scale_color_manual(values = cols[match(cols2use, names(cols))])+
    labs(x = "", y = "Costs [$/km]", title = paste0("Example of ", vt))+
    theme_plot

  return(p)
}

plotCost(costs = techcost, vt = "Large Car and SUV")
plotCost(costs = techcost, vt = "Midsize Car")
plotCost(costs = techcost, vt = "Subcompact Car")
plotCost(costs = techcost, vt = "Passenger Rail_tmp_vehicletype")

```
# ES validation for selected categories and regions

## Passenger transport in DEU 2018

```{r, echo=FALSE, warning=FALSE, message=FALSE}

es_deu_verkehrinzahlen <- function(demandkm){
  demand_deu <- demand_km[region == "DEU" & sector == "trn_pass"]
  demand_deu <- rmndt::approx_dt(demand_deu, c(2015, 2018, 2020), "year", "demand_F",
                                 idxcols=colnames(demand_deu)[3:9])[year == 2018]
  toplot <- demand_deu[, .(model="EDGE-T", demand=1e-3*sum(demand_F)), by=c("subsector_L2")] # millions -> billions
  toplot[, subsector_L2 := gsub("_tmp_subsector_L2", "", subsector_L2)]
  toplot[, subsector_L2 := gsub("trn_pass_road_", "", subsector_L2)]

  ## Verkehr-in-Zahlen 2020, https://www.bmvi.de/SharedDocs/DE/Artikel/G/verkehr-in-zahlen.html, p224-225
  vkiz <- fread(text="
model,subsector_L2,demand
ViZ,Cycle, 39.8
ViZ,Domestic Aviation, 70.4
ViZ,Passenger Rail, 98.2
ViZ,Walk, 35.9
ViZ,Bus, 80.1,
ViZ,LDV, 913.3
")[, demand := demand]

  toplot <- rbind(toplot, vkiz)

  p <- ggplot(toplot, aes(x=model, y=demand)) +
    geom_bar(stat="identity", fill="blue") +
    facet_wrap(~subsector_L2, scales="free_y") +
    labs(y="Transport Demand 2018 [billion pkm]") +
    theme_plot
  return(p)
}

es_deu_verkehrinzahlen(demandkm)
```
